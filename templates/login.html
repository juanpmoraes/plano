{% extends "base.html" %}
{% block title %}Login | JPBOT{% endblock %}

{% block content %}
  <div class="grid">
    <div class="card" style="grid-column: span 12;">
      <div class="h1">Entrar</div>
      <div class="muted">Use o email e senha cadastrados.</div>
    </div>

    <div class="card" style="grid-column: span 6;">
      <div class="h2">Login</div>
      <div class="row">
        <input id="login_email" class="input" type="email" placeholder="Email" autocomplete="email">
        <input id="login_senha" class="input" type="password" placeholder="Senha" autocomplete="current-password">
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn btn-primary" id="btnLogin">Entrar</button>
        <span id="loginMsg" class="muted small"></span>
      </div>
      <div class="hr"></div>
      <div class="muted small">
        Dica: usuário teste: <span class="mono">teste@email.com</span> / <span class="mono">teste123</span>
      </div>
    </div>

    <div class="card" style="grid-column: span 6;">
      <div class="h2">Criar conta</div>
      <div class="row">
        <input id="reg_nome" class="input" type="text" placeholder="Nome">
        <input id="reg_email" class="input" type="email" placeholder="Email">
        <input id="reg_senha" class="input" type="password" placeholder="Senha">
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnRegister">Cadastrar</button>
        <span id="regMsg" class="muted small"></span>
      </div>
      <div class="hr"></div>
      <div class="muted small">Ao cadastrar, o plano inicial será <span class="mono">free</span>.</div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  async function postJSON(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  document.getElementById("btnLogin").addEventListener("click", async () => {
    const email = document.getElementById("login_email").value.trim();
    const senha = document.getElementById("login_senha").value;

    const msg = document.getElementById("loginMsg");
    msg.textContent = "Entrando...";

    const r = await postJSON("/login", { email, senha });
    if (r.data && r.data.success) {
      window.location.href = r.data.redirect || "/dashboard";
      return;
    }
    msg.textContent = (r.data && r.data.message) ? r.data.message : ("Falha no login (" + r.status + ")");
  });

  document.getElementById("btnRegister").addEventListener("click", async () => {
    const nome = document.getElementById("reg_nome").value.trim();
    const email = document.getElementById("reg_email").value.trim();
    const senha = document.getElementById("reg_senha").value;

    const msg = document.getElementById("regMsg");
    msg.textContent = "Cadastrando...";

    const r = await postJSON("/register", { nome, email, senha });
    msg.textContent = (r.data && r.data.message) ? r.data.message : (r.data && r.data.success ? "OK" : "Erro");
    if (r.data && r.data.success) {
      document.getElementById("login_email").value = email;
      document.getElementById("login_senha").value = senha;
    }
  });
</script>
{% endblock %}
