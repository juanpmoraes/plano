{% extends "base.html" %}
{% block title %}Dashboard | JPBOT{% endblock %}

{% block content %}
  <div class="grid">
    <div class="card" style="grid-column: span 12;">
      <div class="h1">Dashboard</div>
      <div class="muted">Gerencie seus projetos, plano, quota e API Keys.</div>
    </div>

    <div class="card" style="grid-column: span 4;">
      <div class="h2">Projetos</div>
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-size:26px; font-weight:700;">{{ stats.projetos }}</div>
          <div class="muted small">Total de projetos</div>
        </div>
        <div class="right">
          <div class="tag warn small" id="limiteProjetosTag">Limite: {{ stats.limite_projetos }}</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted small">Dica: crie projetos pela seção “Projetos”.</div>
    </div>

    <div class="card" style="grid-column: span 4;">
      <div class="h2">Usuários ativos</div>
      <div style="font-size:26px; font-weight:700;">{{ stats.total_usuarios }}</div>
      <div class="muted small">Total de usuários ativos no sistema</div>
    </div>

    <div class="card" style="grid-column: span 4;">
      <div class="h2">Quota API (mês)</div>
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-size:26px; font-weight:700;" id="apiUsed">—</div>
          <div class="muted small">Usadas</div>
        </div>
        <div class="right">
          <div style="font-size:26px; font-weight:700;" id="apiLimit">—</div>
          <div class="muted small">Limite</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <span class="pill small mono" id="anoMes">—</span>
        <a class="pill small" href="/planos">Fazer upgrade</a>
      </div>
    </div>

    <!-- PROJETOS -->
    <div class="card" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h2">Projetos</div>
          <div class="muted small">Listagem e criação.</div>
        </div>
        <button class="btn" id="btnReloadProjetos">Recarregar</button>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div style="grid-column: span 5;">
          <div class="h2">Criar projeto</div>
          <input id="novoProjetoNome" class="input" placeholder="Nome do projeto">
          <div class="row" style="margin-top:10px;">
            <button class="btn btn-primary" id="btnCriarProjeto">Criar</button>
            <span id="projetoMsg" class="muted small"></span>
          </div>
          <div class="hr"></div>
          <div class="muted small">
            Se bater limite de projetos, o backend retorna 403 com a mensagem do plano.
          </div>
        </div>

        <div style="grid-column: span 7;">
          <div class="h2">Sua lista</div>
          <div id="projetosList" class="muted">Carregando...</div>
        </div>
      </div>
    </div>

    <!-- API KEYS -->
    <div class="card" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h2">API Keys</div>
          <div class="muted small">Crie uma key para integrar sem login (Authorization: Bearer ...).</div>
        </div>
        <div class="row">
          <button class="btn" onclick="loadApiKeys()">Atualizar</button>
          <button class="btn btn-primary" onclick="criarApiKey()">Criar API Key</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="keysMsg" class="muted small">—</div>
      <div id="keysList" class="muted" style="margin-top:10px;">Carregando...</div>

      <!-- Modal simples (mostra a key só quando cria) -->
      <div class="card hidden" id="keyModal" style="margin-top:12px; border-color: rgba(96,165,250,.55);">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="h2">Sua nova API Key</div>
            <div class="muted small">Copie agora. Ela não será mostrada novamente.</div>
          </div>
          <button class="btn btn-danger" onclick="fecharKeyModal()">Fechar</button>
        </div>

        <div class="hr"></div>

        <div class="muted small">Header:</div>
        <div class="pill mono" style="width:100%; overflow:auto;">
          Authorization: Bearer <span id="newKeyValue"></span>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="copiarNovaKey()">Copiar</button>
          <span class="muted small" id="copyMsg"></span>
        </div>
      </div>
    </div>

    <!-- STATUS -->
    <div class="card" style="grid-column: span 12;">
      <div class="h2">Status</div>
      <div class="row" style="gap:12px;">
        <span class="pill small">Nome: <b id="userNome">—</b></span>
        <span class="pill small">Email: <b id="userEmail">—</b></span>
        <span class="pill small">Plano: <b id="userPlano">—</b></span>
      </div>
      <div class="hr"></div>
      <div id="statusMsg" class="muted small">—</div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  async function getJSON(url){
    const res = await fetch(url, { credentials: "same-origin" });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  async function postJSON(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function escapeHtml(s){
    return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
                    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderProjetos(payload){
    const el = document.getElementById("projetosList");
    if (!payload || !payload.success) {
      el.textContent = "Falha ao carregar projetos.";
      return;
    }
    const projetos = payload.projetos || [];
    if (!projetos.length){
      el.innerHTML = "<div class='muted'>Nenhum projeto ainda.</div>";
      return;
    }
    el.innerHTML = projetos.map(p => {
      const d = (p.data_criacao || "").toString();
      const nomeEsc = escapeHtml(p.nome || "");
      return `
        <div class="card" style="margin-bottom:10px;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <b>${nomeEsc}</b>
              <div class="muted small">Criado em: ${escapeHtml(d)}</div>
            </div>
            <div class="right small">
              <button class="btn small" onclick="verHistorico(${p.id})">Histórico</button>
              <button class="btn small" onclick="renomearProjeto(${p.id})">Renomear</button>
              <button class="btn small" onclick="duplicarProjeto(${p.id})">Duplicar</button>
              <button class="btn btn-danger small" onclick="excluirProjeto(${p.id})">Excluir</button>
              <div class="muted mono">#${p.id}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function loadUserInfo(){
    const r = await getJSON("/api/user_info");
    if (!r.ok || !r.data.success){
      document.getElementById("statusMsg").textContent = "Não autenticado (recarregue a página).";
      return;
    }
    document.getElementById("userNome").textContent = r.data.nome || "—";
    document.getElementById("userEmail").textContent = r.data.email || "—";
    document.getElementById("userPlano").textContent = r.data.plano || "—";
  }

  async function loadQuota(){
    const r = await getJSON("/api/quota");
    if (!r.ok || !r.data.success){
      document.getElementById("apiUsed").textContent = "—";
      document.getElementById("apiLimit").textContent = "—";
      document.getElementById("anoMes").textContent = "—";
      return;
    }
    document.getElementById("apiUsed").textContent = r.data.used ?? "0";
    document.getElementById("apiLimit").textContent = r.data.limit ?? "—";
    document.getElementById("anoMes").textContent = r.data.ano_mes ?? "—";
  }

  async function loadProjetos(){
    const r = await getJSON("/api/projetos");
    if (r.status === 429){
      const quota = r.data && r.data.quota ? r.data.quota : null;
      document.getElementById("statusMsg").textContent =
        "Quota de API atingida. Use /api/quota ou faça upgrade. " + (quota ? ("(" + JSON.stringify(quota) + ")") : "");
      document.getElementById("projetosList").textContent = "Quota de API atingida.";
      return;
    }
    renderProjetos(r.data);
  }

  document.getElementById("btnReloadProjetos").addEventListener("click", loadProjetos);

  document.getElementById("btnCriarProjeto").addEventListener("click", async () => {
    const nome = document.getElementById("novoProjetoNome").value.trim();
    const msg = document.getElementById("projetoMsg");
    msg.textContent = "Enviando...";

    const r = await postJSON("/api/projetos", { nome });
    if (r.status === 429){
      msg.textContent = "Quota mensal de API atingida.";
      return;
    }
    if (!r.ok || !r.data.success){
      msg.textContent = (r.data && r.data.message) ? r.data.message : ("Erro ("+r.status+")");
      return;
    }
    msg.textContent = "Projeto criado!";
    document.getElementById("novoProjetoNome").value = "";
    await loadProjetos();
    await loadQuota();
  });

  async function renomearProjeto(id){
    const novoNome = window.prompt("Novo nome do projeto:");
    if (!novoNome || !novoNome.trim()) return;

    const msg = document.getElementById("projetoMsg");
    msg.textContent = "Renomeando...";

    const r = await fetch(`/api/projetos/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ nome: novoNome.trim() })
    });

    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.success){
      msg.textContent = (data && data.message) ? data.message : ("Erro ao renomear ("+r.status+")");
      return;
    }
    msg.textContent = "Projeto renomeado!";
    await loadProjetos();
  }

  async function excluirProjeto(id){
    if (!window.confirm("Tem certeza que deseja excluir este projeto?")) return;

    const msg = document.getElementById("projetoMsg");
    msg.textContent = "Excluindo...";

    const r = await fetch(`/api/projetos/${id}`, {
      method: "DELETE",
      credentials: "same-origin"
    });

    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.success){
      msg.textContent = (data && data.message) ? data.message : ("Erro ao excluir ("+r.status+")");
      return;
    }
    msg.textContent = "Projeto excluído.";
    await loadProjetos();
  }

  async function duplicarProjeto(id){
    const msg = document.getElementById("projetoMsg");
    msg.textContent = "Duplicando...";

    const r = await fetch(`/api/projetos/${id}/duplicar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin"
    });

    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.success){
      msg.textContent = (data && data.message) ? data.message : ("Erro ao duplicar ("+r.status+")");
      return;
    }
    msg.textContent = "Projeto duplicado!";
    await loadProjetos();
  }

  async function verHistorico(id){
    const r = await fetch(`/api/projetos/${id}/historico`, { credentials: "same-origin" });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.success){
      alert((data && data.message) ? data.message : "Erro ao carregar histórico");
      return;
    }

    const lines = (data.items || []).map(x => {
      return `${x.criado_em} | ${x.acao} | antes=${JSON.stringify(x.antes)} | depois=${JSON.stringify(x.depois)}`;
    });

    alert(lines.join("\n") || "Sem histórico ainda.");
  }

  // -------------------------
  // API KEYS UI
  // -------------------------
  function fecharKeyModal(){
    document.getElementById("keyModal").classList.add("hidden");
    document.getElementById("newKeyValue").textContent = "";
    document.getElementById("copyMsg").textContent = "";
  }

  async function copiarNovaKey(){
    const key = document.getElementById("newKeyValue").textContent.trim();
    if (!key) return;

    try{
      await navigator.clipboard.writeText(key);
      document.getElementById("copyMsg").textContent = "Copiado!";
    } catch(e){
      document.getElementById("copyMsg").textContent = "Falha ao copiar (permissão do navegador).";
    }
    setTimeout(() => (document.getElementById("copyMsg").textContent = ""), 1400);
  }

  function renderApiKeys(items){
    const el = document.getElementById("keysList");
    if (!items || !items.length){
      el.innerHTML = "<div class='muted'>Nenhuma API key ainda.</div>";
      return;
    }

    el.innerHTML = items.map(k => {
      const status = k.ativo
        ? "<span class='tag ok small'>Ativa</span>"
        : "<span class='tag bad small'>Revogada</span>";

      const btn = k.ativo
        ? `<button class="btn btn-danger small" onclick="revogarApiKey(${k.id})">Revogar</button>`
        : `<button class="btn small" disabled>Revogada</button>`;

      return `
        <div class="card" style="margin-bottom:10px;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <b>${escapeHtml(k.nome || "API Key")}</b>
              <div class="muted small">Prefixo: <span class="mono">${escapeHtml(k.prefixo || "")}</span></div>
              <div class="muted small">Criada em: ${escapeHtml((k.criado_em || "").toString())}</div>
            </div>
            <div class="right">
              ${status}
              <div style="height:8px;"></div>
              ${btn}
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function loadApiKeys(){
    document.getElementById("keysMsg").textContent = "Carregando...";
    const r = await getJSON("/api/keys");
    if (!r.ok || !r.data.success){
      document.getElementById("keysMsg").textContent = "Erro ao carregar API keys.";
      document.getElementById("keysList").textContent = "";
      return;
    }
    document.getElementById("keysMsg").textContent = "OK";
    renderApiKeys(r.data.items || []);
  }

  async function criarApiKey(){
    const nome = window.prompt("Nome da API key (ex: 'Integração Bot'):");
    if (!nome) return;

    document.getElementById("keysMsg").textContent = "Criando...";
    const r = await postJSON("/api/keys", { nome });

    if (!r.ok || !r.data.success){
      document.getElementById("keysMsg").textContent = (r.data && r.data.message) ? r.data.message : "Erro ao criar key.";
      return;
    }

    document.getElementById("newKeyValue").textContent = r.data.api_key || "";
    document.getElementById("keyModal").classList.remove("hidden");
    document.getElementById("keysMsg").textContent = "Key criada. Copie no bloco acima.";

    await loadApiKeys();
  }

  async function revogarApiKey(id){
    if (!window.confirm("Revogar esta API key?")) return;

    document.getElementById("keysMsg").textContent = "Revogando...";
    const r = await postJSON(`/api/keys/${id}/revogar`, {});
    if (!r.ok || !r.data.success){
      document.getElementById("keysMsg").textContent = "Erro ao revogar key.";
      return;
    }
    document.getElementById("keysMsg").textContent = "Revogada.";
    await loadApiKeys();
  }

  // init
  (async () => {
    await loadUserInfo();
    await loadQuota();
    await loadProjetos();
    await loadApiKeys();
  })();
</script>
{% endblock %}
