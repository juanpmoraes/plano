{% extends "base.html" %}
{% block title %}Planos | JPBOT{% endblock %}

{% block content %}
  <div class="grid">
    <div class="card" style="grid-column: span 12;">
      <div class="h1">Planos</div>
      <div class="muted">Selecione um plano para ativar recursos e quota de API.</div>
    </div>

    {% set plano_atual = session.get('user_plano', 'free') %}
    {% for key, p in planos.items() %}
      <div class="card" style="grid-column: span 4;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="h2">{{ p.nome }}</div>
            <div class="muted small">ID: <span class="mono">{{ key }}</span></div>
          </div>
          {% if key == plano_atual %}
            <span class="tag ok small">Atual</span>
          {% else %}
            <span class="tag small">Disponível</span>
          {% endif %}
        </div>

        <div class="hr"></div>

        <div style="font-size:26px; font-weight:700;">
          R$ {{ "%.2f"|format(p.preco) }}
          <span class="muted small">/mês</span>
        </div>

        <div class="hr"></div>

        <div class="muted small">Recursos</div>
        <ul class="list">
          {% for r in p.recursos %}
            <li>{{ r }}</li>
          {% endfor %}
        </ul>

        <div class="hr"></div>

        <div class="muted small">Limites</div>
        <ul class="list">
          <li>Projetos: <span class="mono">{{ p.limites.projetos if p.limites.projetos is not none else "ilimitado" }}</span></li>
          <li>API calls/mês: <span class="mono">{{ p.limites.api_calls_mes }}</span></li>
        </ul>

        <div class="hr"></div>

        <button
          class="btn {% if key != plano_atual %}btn-primary{% endif %}"
          {% if key == plano_atual %}disabled{% endif %}
          onclick="selecionarPlano('{{ key }}')">
          {% if key == plano_atual %}Plano atual{% else %}Selecionar{% endif %}
        </button>
      </div>
    {% endfor %}

    <div class="card hidden" id="payCard" style="grid-column: span 12;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h2">Pagamento PIX</div>
          <div class="muted small">Se for plano pago, gere o PIX e aguarde a confirmação.</div>
        </div>
        <button class="btn btn-danger" onclick="fecharPagamento()">Fechar</button>
      </div>

      <div class="hr"></div>

      <div id="payMsg" class="muted">—</div>

      <div class="grid" style="margin-top:12px;">
        <div style="grid-column: span 5;">
          <div class="muted small">QR Code</div>
          <div class="card" style="text-align:center;">
            <img id="qrImg" alt="QR Code PIX" style="max-width:260px; width:100%; height:auto; display:none;" />
            <div id="qrFallback" class="muted small">Aguardando geração...</div>
          </div>
        </div>
        <div style="grid-column: span 7;">
          <div class="muted small">Copia e cola</div>
          <textarea id="qrString" class="input mono" rows="6" readonly placeholder="copia e cola aparecerá aqui..."></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn" onclick="copiarQrString()">Copiar</button>
            <button class="btn" id="btnVerificar" onclick="verificarAgora()" disabled>Verificar agora</button>
            <span class="muted small" id="verifMsg"></span>
          </div>
          <div class="hr"></div>
          <div class="muted small">
            Quando confirmar, você será redirecionado para o dashboard.
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  let currentPixId = null;
  let currentPlano = null;
  let pollTimer = null;

  async function postJSON(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  async function getJSON(url){
    const res = await fetch(url, { credentials: "same-origin" });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function abrirPagamento(){
    document.getElementById("payCard").classList.remove("hidden");
    document.getElementById("payMsg").textContent = "Gerando pagamento...";
    document.getElementById("verifMsg").textContent = "";
    document.getElementById("btnVerificar").disabled = true;
    document.getElementById("qrImg").style.display = "none";
    document.getElementById("qrFallback").textContent = "Aguardando geração...";
    document.getElementById("qrString").value = "";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function fecharPagamento(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    currentPixId = null;
    currentPlano = null;
    document.getElementById("payCard").classList.add("hidden");
  }

  function copiarQrString(){
    const el = document.getElementById("qrString");
    if (!el.value) return;
    el.select();
    document.execCommand("copy");
    document.getElementById("verifMsg").textContent = "Copiado.";
    setTimeout(() => (document.getElementById("verifMsg").textContent = ""), 1200);
  }

  async function selecionarPlano(plano){
    currentPlano = plano;

    // Free: troca imediata (backend atualiza plano e retorna success)
    if (plano === "free"){
      const r = await postJSON("/criar_pagamento", { plano: "free" });
      if (r.data && r.data.success){
        window.location.href = "/dashboard";
        return;
      }
      alert((r.data && r.data.message) ? r.data.message : "Erro ao trocar para free");
      return;
    }

    const cpf = window.prompt("Digite seu CPF (somente números ou com pontuação):");
    if (!cpf) return;

    abrirPagamento();
    const r = await postJSON("/criar_pagamento", { plano, cpf });

    if (!r.ok || !r.data.success){
      document.getElementById("payMsg").textContent = (r.data && r.data.message) ? r.data.message : "Erro ao gerar PIX.";
      return;
    }

    currentPixId = r.data.pix_id;
    document.getElementById("payMsg").textContent =
      "PIX gerado. Plano: " + plano + " | Valor: R$ " + (r.data.valor ?? "—") + " | pix_id=" + currentPixId;

    if (r.data.qr_code){
      const img = document.getElementById("qrImg");
      img.src = "data:image/png;base64," + r.data.qr_code;
      img.style.display = "block";
      document.getElementById("qrFallback").textContent = "";
    } else {
      document.getElementById("qrFallback").textContent = "QR code indisponível, use o copia e cola.";
    }

    if (r.data.qr_string){
      document.getElementById("qrString").value = r.data.qr_string;
    }

    document.getElementById("btnVerificar").disabled = false;

    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(verificarAgora, 5000);
  }

  async function verificarAgora(){
    if (!currentPixId) return;
    const msg = document.getElementById("verifMsg");
    msg.textContent = "Verificando...";

    const r = await getJSON("/verificar_pagamento/" + encodeURIComponent(currentPixId));
    if (!r.ok){
      msg.textContent = "Erro ao verificar (" + r.status + ")";
      return;
    }

    if (r.data && r.data.success && r.data.status === "confirmado"){
      msg.textContent = "Confirmado! Redirecionando...";
      if (pollTimer) clearInterval(pollTimer);
      setTimeout(() => window.location.href = "/dashboard", 800);
      return;
    }

    msg.textContent = "Ainda pendente...";
  }
</script>
{% endblock %}
